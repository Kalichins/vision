<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–í—ã–±–æ—Ä –º–µ—Å—Ç - VISION</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <a class="brand" href="index.html" aria-label="VISION">
        <img class="brand-logo" src="img/vision.png" alt="VISION">
      </a>
      <span id="clubBadge" class="badge"></span>
    </div>

    <div class="card pad">
      <div class="h1">–í—ã–±–æ—Ä –º–µ—Å—Ç–∞</div>
      <p class="p">–ó–æ–Ω–∞ ‚Üí –º–µ—Å—Ç–∞ ‚Üí –¥–∞—Ç–∞/–≤—Ä–µ–º—è ‚Üí –ª—é–¥–∏.</p>
      <hr class="sep">

      <div class="grid cols-2">
        <!-- LEFT -->
        <div class="card pad" style="background:rgba(0,0,0,.18)">
          <div style="font-weight:900; margin-bottom:8px">–ó–æ–Ω–∞</div>

          <div class="segment" id="zones">
            <div class="choice" data-zone="–û–±—â–∏–π –∑–∞–ª">
              <h3>–û–±—â–∏–π –∑–∞–ª</h3>
              <p>–ë–æ–ª—å—à–µ –º–µ—Å—Ç, –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–∞–π—Å</p>
              <div class="specs">
                <div><span>–ü–ö:</span> i5 / Ryzen 5, RTX 2060‚Äì3060</div>
                <div><span>–ú–æ–Ω–∏—Ç–æ—Ä:</span> 144Hz, 24"</div>
                <div><span>–ü–µ—Ä–∏—Ñ–µ—Ä–∏—è:</span> —Å—Ç–∞–Ω–¥–∞—Ä—Ç (Logitech/HyperX)</div>
              </div>
            </div>

            <div class="choice" data-zone="VIP">
              <h3>VIP</h3>
              <p>–ö–æ–º—Ñ–æ—Ä—Ç + –º–æ—â–Ω–µ–µ –∂–µ–ª–µ–∑–æ</p>
              <div class="specs">
                <div><span>–ü–ö:</span> i7 / Ryzen 7, RTX 3070‚Äì4070</div>
                <div><span>–ú–æ–Ω–∏—Ç–æ—Ä:</span> 240Hz, 24‚Äì27"</div>
                <div><span>–ü–µ—Ä–∏—Ñ–µ—Ä–∏—è:</span> –ø—Ä–µ–º–∏—É–º, –∫—Ä–µ—Å–ª–∞ –ª—É—á—à–µ</div>
              </div>
            </div>

            <div class="choice" data-zone="Bootcamp">
              <h3>Bootcamp</h3>
              <p>–ö–æ–º–Ω–∞—Ç–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã (—Å–∫–≤–∞–¥)</p>
              <div class="specs">
                <div><span>–ü–ö:</span> i7/i9, RTX 4070‚Äì4080</div>
                <div><span>–ú–æ–Ω–∏—Ç–æ—Ä:</span> 240Hz+</div>
                <div><span>–§–∏—à–∫–∏:</span> —Ç–∏—à–µ, –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å, –∫–æ–º–∞–Ω–¥–Ω—ã–π –≤–∞–π–±</div>
              </div>
            </div>
          </div>

          <hr class="sep">

          <div class="row" style="justify-content:space-between; margin-bottom:10px">
            <div class="row" style="gap:10px">
              <span class="pill">üü¢ —Å–≤–æ–±–æ–¥–Ω–æ</span>
              <span class="pill" style="border-color:rgba(239,68,68,.55); color:#fca5a5">üî¥ –∑–∞–Ω—è—Ç–æ</span>
              <span class="pill" style="border-color:rgba(124,58,237,.8); color:#c4b5fd">üü£ –≤—ã–±—Ä–∞–Ω–æ</span>
            </div>
            <button id="clearSeats" class="btn ghost">–°–Ω—è—Ç—å –≤—ã–±–æ—Ä</button>
          </div>

          <div id="seats" class="seats"></div>
        </div>

        <!-- RIGHT -->
        <div class="card pad" style="background:rgba(0,0,0,.18)">
          <div style="font-weight:900; margin-bottom:8px">–î–∞—Ç–∞, –≤—Ä–µ–º—è, –ª—é–¥–∏</div>

          <div class="calendar">
            <div class="cal-header">
              <button class="cal-nav" id="prevMonth">‚Äπ</button>
              <div class="cal-title" id="calTitle"></div>
              <button class="cal-nav" id="nextMonth">‚Ä∫</button>
            </div>

            <div class="cal-days">
              <div>–ü–Ω</div><div>–í—Ç</div><div>–°—Ä</div>
              <div>–ß—Ç</div><div>–ü—Ç</div><div>–°–±</div><div>–í—Å</div>
            </div>

            <div class="cal-grid" id="calendar"></div>
          </div>

          <!-- TIME: custom select -->
          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</label>

              <div class="cselect" id="timeCS">
                <button class="cselect-btn" type="button">
                  <span class="cselect-label" data-placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è‚Ä¶">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è‚Ä¶</span>
                  <span class="cselect-arrow"></span>
                </button>
                <input type="hidden" id="timeValue" value="">
                <div class="cselect-menu" id="timeMenu"></div>
              </div>

            </div>
          </div>

          <!-- PEOPLE: custom select -->
          <div class="row">
            <div class="field">
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π</label>

              <div class="cselect" id="peopleCS">
                <button class="cselect-btn" type="button">
                  <span class="cselect-label" data-placeholder="–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</span>
                  <span class="cselect-arrow"></span>
                </button>
                <input type="hidden" id="peopleValue" value="">
                <div class="cselect-menu">
                  <div class="cselect-item" data-value="1">1</div>
                  <div class="cselect-item" data-value="2">2</div>
                  <div class="cselect-item" data-value="3">3</div>
                  <div class="cselect-item" data-value="4">4</div>
                  <div class="cselect-item" data-value="5">5</div>
                </div>
              </div>

              <small class="help">–ü–æ–∑–∂–µ –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤—ã–±–æ—Ä –º–µ—Å—Ç –ø–æ –ª—é–¥—è–º.</small>
            </div>
          </div>
        </div>
      </div>

      <div class="actionbar">
        <div class="summary">
          <div class="top" id="sumTop">–ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</div>
          <div class="sub" id="sumSub">–í—ã–±–µ—Ä–∏—Ç–µ –∑–æ–Ω—É –∏ –º–µ—Å—Ç–∞</div>
        </div>
        <div class="row">
          <a class="btn ghost" href="clubs.html">‚Üê –ù–∞–∑–∞–¥</a>
          <button id="next" class="btn primary" disabled>–í—ã–±—Ä–∞—Ç—å –ø–∞–∫–µ—Ç ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    injectSponsorFooter();

    const city = GV.get("city");
    const club = GV.get("club");
    if(!city) goto("index.html");
    if(!club) goto("clubs.html");
    qs("#clubBadge").textContent = `${city} ‚Ä¢ ${club.name}`;

    // ------ ZONE CONFIG (—Ä–∞–∑–Ω—ã–µ –º–µ—Å—Ç–∞) ------
    const ZONE_CONF = {
      "–û–±—â–∏–π –∑–∞–ª": { prefix:"G", count:24 },
      "VIP": { prefix:"V", count:8 },
      "Bootcamp": { prefix:"B", count:8 }
    };

    // ------ Zone ------
    let zone = GV.get("zone", null);
    function setZone(z){
      zone = z;
      GV.set("zone", z);
      qsa("#zones .choice").forEach(x => x.classList.toggle("active", x.dataset.zone === z));
      // –ø—Ä–∏ —Å–º–µ–Ω–µ –∑–æ–Ω—ã ‚Äî —Å–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç
      GV.set("seats", []);
      selected = new Set();
      renderSeats();
      updateSummary();
    }
    qs("#zones").addEventListener("click", (e)=>{
      const card = e.target.closest(".choice");
      if(card) setZone(card.dataset.zone);
    });
    if(zone) setZone(zone);

    // ------ Custom selects init ------
    const peopleHidden = qs("#peopleValue");
    const timeHidden = qs("#timeValue");

    // saved values
    const savedPeople = GV.get("people", "1");
    peopleHidden.value = savedPeople;

    const savedTime = GV.get("time", "18:00");

    // init people custom select
    const peopleCS = initCustomSelect(qs("#peopleCS"));
    peopleCS.setValue(savedPeople, savedPeople);

    qs("#peopleCS").addEventListener("change", ()=>{
      GV.set("people", peopleHidden.value);
      updateSummary();
    });

    // build time options (step 30 min)
    function roundToStep(timeStr, step=30){
      const [h,m] = timeStr.split(":").map(Number);
      const total = h*60+m;
      const rounded = Math.round(total/step)*step;
      const hh = String(Math.floor(rounded/60)).padStart(2,"0");
      const mm = String(rounded%60).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    function fillTimeMenu(stepMinutes=30, start="10:00", end="23:00"){
      const menu = qs("#timeMenu");
      menu.innerHTML = "";

      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let t = sh*60 + sm;
      const endT = eh*60 + em;

      while(t <= endT){
        const hh = String(Math.floor(t/60)).padStart(2,"0");
        const mm = String(t%60).padStart(2,"0");
        const v = `${hh}:${mm}`;
        const item = document.createElement("div");
        item.className = "cselect-item";
        item.dataset.value = v;
        item.textContent = v;
        menu.appendChild(item);
        t += stepMinutes;
      }
    }

    fillTimeMenu(30, "10:00", "23:00");

    // set default time (rounded)
    const t0 = roundToStep(savedTime, 30);
    timeHidden.value = t0;
    GV.set("time", t0);

    // init time custom select AFTER menu filled
    const timeCS = initCustomSelect(qs("#timeCS"));
    timeCS.setValue(t0, t0);

    qs("#timeCS").addEventListener("change", ()=>{
      GV.set("time", timeHidden.value);
      updateSummary();
    });

    // ------ Seats (–ø–æ –∑–æ–Ω–µ —Ä–∞–∑–Ω—ã–µ) ------
    const seatsWrap = qs("#seats");

    // busy seats per zone stored by club
    let busyByZone = GV.get("busySeatsByZone", null);
    if(!busyByZone){
      busyByZone = {};
      Object.keys(ZONE_CONF).forEach(z=>{
        const {count} = ZONE_CONF[z];
        const seed = (club.id.length + club.name.length + z.length);
        const busy = [];
        for(let i=1;i<=count;i++){
          if((i*seed)%7===0 || (i*seed)%11===0) busy.push(i);
        }
        busyByZone[z] = busy;
      });
      GV.set("busySeatsByZone", busyByZone);
    }

    let selected = new Set(GV.get("seats", []));

    function seatLabel(i){
      const {prefix} = ZONE_CONF[zone];
      return `${prefix}-${String(i).padStart(2,"0")}`;
    }

    function renderSeats(){
      seatsWrap.innerHTML = "";
      if(!zone){
        for(let i=1;i<=12;i++){
          const el = document.createElement("div");
          el.className = "seat";
          el.style.opacity = ".35";
          el.textContent = "‚Äî";
          seatsWrap.appendChild(el);
        }
        return;
      }

      const {count} = ZONE_CONF[zone];
      const busy = new Set(busyByZone[zone] || []);

      for(let i=1;i<=count;i++){
        const isBusy = busy.has(i);
        const el = document.createElement("div");
        el.className = "seat" + (isBusy ? " busy" : "") + (selected.has(i) ? " selected" : "");
        el.textContent = seatLabel(i);

        el.addEventListener("click", ()=>{
          if(isBusy) return;
          if(selected.has(i)) selected.delete(i);
          else selected.add(i);

          GV.set("seats", Array.from(selected));
          renderSeats();
          updateSummary();
        });

        seatsWrap.appendChild(el);
      }
    }

    qs("#clearSeats").addEventListener("click", ()=>{
      selected = new Set();
      GV.set("seats", []);
      renderSeats();
      updateSummary();
    });

    // ------ Calendar ------
    const calendarEl = qs("#calendar");
    const titleEl = qs("#calTitle");
    let current = new Date();

    let selectedDate = null;
    const savedDate = GV.get("date", null);
    if(savedDate){
      selectedDate = new Date(savedDate + "T00:00:00");
      current = new Date(selectedDate);
    } else {
      const iso = new Date().toISOString().slice(0,10);
      selectedDate = new Date(iso + "T00:00:00");
      GV.set("date", iso);
    }

    function renderCalendar(){
      calendarEl.innerHTML = "";
      const year = current.getFullYear();
      const month = current.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = (firstDay.getDay() + 6) % 7;

      titleEl.textContent = current.toLocaleString("ru-RU", { month:"long", year:"numeric" });

      for(let i=0;i<startDay;i++) calendarEl.appendChild(document.createElement("div"));

      const today = new Date();
      const todayMid = new Date(today.getFullYear(), today.getMonth(), today.getDate());

      for(let d=1; d<=lastDay.getDate(); d++){
        const date = new Date(year, month, d);
        const el = document.createElement("div");
        el.className = "cal-day";
        el.textContent = d;

        if(date < todayMid) el.classList.add("disabled");
        if(selectedDate && date.toDateString() === selectedDate.toDateString()) el.classList.add("selected");

        el.addEventListener("click", ()=>{
          selectedDate = date;
          GV.set("date", date.toISOString().slice(0,10));
          renderCalendar();
          updateSummary();
        });

        calendarEl.appendChild(el);
      }
    }

    qs("#prevMonth").onclick = ()=>{ current.setMonth(current.getMonth()-1); renderCalendar(); };
    qs("#nextMonth").onclick = ()=>{ current.setMonth(current.getMonth()+1); renderCalendar(); };

    // ------ Summary ------
    function updateSummary(){
      const seatsCount = selected.size;
      const dateStr = GV.get("date");
      const when = `${dateStr} ‚Ä¢ ${timeHidden.value}`;
      const ppl = peopleHidden.value;

      const top = qs("#sumTop");
      const sub = qs("#sumSub");
      const next = qs("#next");

      if(!zone){
        top.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–æ–Ω—É";
        sub.textContent = `–î–∞—Ç–∞/–≤—Ä–µ–º—è: ${when} ‚Ä¢ –õ—é–¥–µ–π: ${ppl}`;
        next.disabled = true;
        return;
      }

      if(seatsCount === 0){
        top.textContent = `–ó–æ–Ω–∞: ${zone}`;
        sub.textContent = `–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–∞ ‚Ä¢ ${when} ‚Ä¢ –õ—é–¥–µ–π: ${ppl}`;
        next.disabled = true;
        return;
      }

      top.textContent = `–ó–æ–Ω–∞: ${zone} ‚Ä¢ –ú–µ—Å—Ç: ${seatsCount}`;
      sub.textContent = `${when} ‚Ä¢ –õ—é–¥–µ–π: ${ppl}`;
      next.disabled = false;
    }

    renderSeats();
    renderCalendar();
    updateSummary();

    qs("#next").addEventListener("click", ()=>goto("packages.html"));
  </script>
</body>
</html>
